<script src="lib/nacl_factory.js"></script>
<script>
nacl_factory.instantiate(function (nacl) {
  
	//generate keypair
    var generated_private_key = nacl.random_bytes(32);								//gen priv key
	var private_key_HEX = nacl.to_HEX(generated_private_key);			//to HEX
	var keypair = nacl.crypto_box_keypair_from_raw_sk(generated_private_key);		//calculate PUB and push as bytes in keypair
	var public_key_HEX = nacl.to_HEX(keypair['boxPk']);				//extract PUB to HEX

	document.write('<br>Generated by script ('+private_key_HEX.length/2+' bytes)'+' private_key: '+private_key_HEX+ 	//display priv with length
	'<br>Calculated from private ('+public_key_HEX.length/2+' bytes)'+' public_key: '+public_key_HEX					//display pub with length
	);

	//calculating public key from specified private key
	var specified_private_key_HEX = '5D3E29AF5E2728CADE0D44DAAA407B0F3A32D2E381030BA907F24EABD34C4D82';	//UPPERCASE HEX, 32 bytes
	var specified_private_key_bytes = nacl.from_hex(specified_private_key_HEX); 						//to bytearray

	var keypair2 = nacl.crypto_box_keypair_from_raw_sk(specified_private_key_bytes);					//pub from bytes priv
	var got_public_key_HEX = nacl.to_HEX(keypair2['boxPk']); 											//to HEX
	
	document.write('<hr><br>Specified in code ('+specified_private_key_HEX.length/2+' bytes)'+' private_key: '+specified_private_key_HEX+	//priv+length
	'<br>Calculated from private ('+got_public_key_HEX.length/2+' bytes)'+' public_key: '+got_public_key_HEX+								//pub+length
	'<br>(calculated pub === 27DF58E2B6DCBCCC3F5992395AB57525E76B021A46D43C5CF04C2D4829F20A17) -> '+(got_public_key_HEX==='27DF58E2B6DCBCCC3F5992395AB57525E76B021A46D43C5CF04C2D4829F20A17'),
	'<hr>Test speed of NaCl functions - <a href="benchmark.html">AVAILABLE HERE in benchmark.</a>'
	);
	
	document.write('<hr>Another functions, here:')
	var string = "hello";
	var hello = nacl.encode_utf8(string);
	document.write('<br><br>UTF-8 encoded (bytearray) "'+string+'" in HEX: '+nacl.to_HEX(hello))
	
	var kp = nacl.crypto_box_keypair_from_seed(hello);
	document.write(
	'<br><br>Keypair - from seed (Uint8Array) "'+string+'" in HEX: '+
	'<br>Secret key: '+nacl.to_HEX(kp['boxSk'])+
	'<br>Public key: '+nacl.to_HEX(kp['boxPk'])
	)
	
	var seed = "This is my passphrase";
	var skp = nacl.crypto_sign_keypair_from_seed(nacl.crypto_hash_string(seed).subarray(0, 32));
	document.write(
	'<br><br>Keypair (bytearray) for sign message, from seed "'+seed+'" in HEX: '+
	'<br>Public key: '+nacl.to_HEX(skp['signPk'])+
	'<br>Secret key: '+nacl.to_HEX(skp['signSk'])
	)
	
	var selfShared = nacl.crypto_box_precompute(kp.boxPk, kp.boxSk);
	document.write(
	'<br><br>K-key (bytes) for precomputation, in HEX: '+nacl.to_HEX(selfShared['boxK'])+
	'<br>Old public key, kp.boxPk: '+nacl.to_HEX(kp.boxPk)+
	'<br>Old private key, kp.boxSk: '+nacl.to_HEX(kp.boxSk)
	)

	var n = nacl.crypto_box_random_nonce();
	document.write(
	'<br><br>Random nonce generated, n (bytes), in HEX: '+nacl.to_HEX(n)
	)
	
	//precomputed encryption
    var c = nacl.crypto_box_precomputed(hello, n, selfShared);
	document.write(
	'<br>Precomputing encryption "'+hello+'", using self-share K-key -> cypher, in HEX: '+nacl.to_HEX(c)
	)
	//precomputing decryption
    var m = nacl.crypto_box_open_precomputed(c, n, selfShared);
	document.write(
	'<br>Turn back "'+hello+'"-bytes from precomputing cypher, using self-shared K-key: '+nacl.to_HEX(m)
	)
	
	//full encryption by keypair
	var c2 = nacl.crypto_box(hello, n, kp.boxPk, kp.boxSk);
	document.write(
	'<br>Encrypted by keypair, UTF-8 encoded "'+string+'" -> to cypher, HEX: '+nacl.to_HEX(c2)
	)
	
	//full decryption by the same keypair
    var m2 = nacl.crypto_box_open(c2, n, kp.boxPk, kp.boxSk);
	document.write(
	'<br>Decrypted by keypair "'+string+'", UTF-8 encoded HEX: '+nacl.to_HEX(m2)
	)
	
	//sign message by signed keypair
    var signed = nacl.crypto_sign(m, skp.signSk);
	document.write(
	'<br>signed "'+nacl.to_HEX(m)+'" using keypair for sign, HEX: '+nacl.to_HEX(signed)
	)
	
	//check signature for signed message.
	signed_HEX = '70A74074E402A61B5A0E9C58F6174B56F61F66F94A360DA9EDF537C4CC32B2BC6524F381C202645B59521FC7AC4A51778693BB710CB5EF825F4F8B9BD489000B68656C6C6F';
	signed = nacl.from_HEX(signed_HEX);
	var signed_open = nacl.crypto_sign_open(signed, skp.signPk);
	document.write(
	'<br><br>Check signature for previous signed HEX (success or error, if incorrect string): '+nacl.to_HEX(signed_open)+
	'<br> ...And this is "hello" bytes (UTF-encoded, in the end of previous HEX)'
	)

	document.write('<BR><BR><b>Encryption and decription using differend keys in crypto_box:</b>');
	//encryption and decryption in crypto-box, using differend keys
	//Alice keys:
	//(32 bytes) private_key: C2FC255008B3D942E06D8F9B2CFD6A72808B3F9872D40D337859847F2BDCFF26
	//(32 bytes) public_key: CB3DC5007CBAF74F4D17FA84457C550A97C4FD350BC24C36869AEF2CA7F0F045
	var Alice_private_key_HEX = 'C2FC255008B3D942E06D8F9B2CFD6A72808B3F9872D40D337859847F2BDCFF26';
	var Alice_private_key_bytes = nacl.from_hex(Alice_private_key_HEX);
	var Alice_keypair = nacl.crypto_box_keypair_from_raw_sk(Alice_private_key_bytes);
	if(
		nacl.to_HEX(Alice_keypair['boxPk'])==='CB3DC5007CBAF74F4D17FA84457C550A97C4FD350BC24C36869AEF2CA7F0F045'
		&&
		nacl.to_HEX(Alice_keypair['boxSk'])===Alice_private_key_HEX		
	){document.write("<BR>Alice['boxPK'] from Alice_priv === Alice_pub")}
	//now She's two keys is as bytes in Alice_keypair
	
	
	//Bob keys
	//(32 bytes) private_key: FE7C55D6A297CCDE13C415EB2482D90B5DDF55DBBEBD0259949AFF9FC6056E90
	//(32 bytes) public_key: 41CFB4822D9E5AECDFDDA8BD546472DCB2BEA29ED56B3DC1094C6FC42538877B
	var Bob_private_key_HEX = 'FE7C55D6A297CCDE13C415EB2482D90B5DDF55DBBEBD0259949AFF9FC6056E90';
	var Bob_private_key_bytes = nacl.from_hex(Bob_private_key_HEX);
	var Bob_keypair = nacl.crypto_box_keypair_from_raw_sk(Bob_private_key_bytes);
	if(
		nacl.to_HEX(Bob_keypair.boxPk)==='41CFB4822D9E5AECDFDDA8BD546472DCB2BEA29ED56B3DC1094C6FC42538877B'
		&&
		nacl.to_HEX(Bob_keypair.boxSk)===Bob_private_key_HEX
	){document.write("<BR>Bob.boxPK from Bob's priv === Bob pub")}
	//now He's two keys is as bytes in Bob_keypair

	
	//full encryption by Alice, using She's private key and Bob's public key
	var message = nacl.to_HEX(nacl.random_bytes(5));
	var message_bytes = nacl.from_hex(message);
	
	var c2 = nacl.crypto_box(message_bytes, n, Bob_keypair.boxPk, Alice_keypair.boxSk); //cypher = encrypt(message, nonce, Bob_pub, Alice_priv)
	document.write(
	'<br>Encrypted "'+message+'" by Alice (using Bob pub and Alice priv) -> to cypher, HEX: '+nacl.to_HEX(c2)
	)
	
	//full decryption by Bob, using He's Private Key and Alice's pub
	var m2 = nacl.crypto_box_open(c2, n, Alice_keypair.boxPk, Bob_keypair.boxSk); //message = decrypt(cypher, nonce, Alice_pub, Bob_priv)
	document.write(
	'<br>Decrypted "'+nacl.to_HEX(c2)+'" by Bob (using Alice pub and Bob priv) -> to message, HEX: '+nacl.to_HEX(m2)
	)
	//check
	if(nacl.to_HEX(m2)===message){document.write('<br>nacl.to_HEX(m2) === message. DECRIPTION OK.')}

	//:-)
});
</script>
